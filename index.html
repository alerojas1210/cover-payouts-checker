<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cover Payouts Checker</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 20px;
}
textarea {
  width: 100%;
  height: 160px;
}
button {
  margin: 8px 6px 16px 0;
  padding: 6px 14px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
th, td {
  border: 1px solid #ccc;
  padding: 4px;
  text-align: right;
}
th {
  background: #000;
  color: #fff;
}
.green { background: #ccffcc; }
.red { background: #ffcccc; }
.yellow { background: #fff2cc; }
.status {
  font-weight: bold;
  margin: 10px 0;
}
</style>
</head>

<body>

<h2>Cover Payouts Checker</h2>
<p>Paste transaction rows below (NO headers):</p>

<textarea id="input"></textarea><br>
<button id="analyzeBtn">Analyze</button>
<button onclick="clearAll()">Clear</button>

<div id="status" class="status"></div>
<div id="output"></div>

<script>
document.getElementById("analyzeBtn").addEventListener("click", analyze);

function analyze() {
  const input = document.getElementById("input").value;

  if (!input.trim()) return;

  // Clean & split rows safely
  let rawRows = input
    .split("\n")
    .map(r => r.trim())
    .filter(r => r.length > 0);

  // Oldest â†’ newest
  rawRows.reverse();

  let pendingPayout = 0;
  let processed = [];

  for (let row of rawRows) {

    // Normalize spaces & tabs
    let cols = row.replace(/\t+/g, " ").split(/\s+/);

    // Must have at least ID + date + time + AM/PM + 3 numbers
    if (cols.length < 8) continue;

    // Last 3 columns are ALWAYS numeric
    let total = parseFloat(cols.pop()) || 0;
    let debit = parseFloat(cols.pop()) || 0;
    let credit = parseFloat(cols.pop()) || 0;

    let doc = cols.shift();
    let date = cols.shift() + " " + cols.shift() + " " + cols.shift();
    let tranType = cols.shift() || "";
    let description = cols.shift() || "";
    let enteredBy = cols.join(" ");

    let rowClass = "green";
    let surplus = "";

    // ðŸ”´ Payout resets logic
    if (debit > 0) {
      pendingPayout = debit;
      rowClass = "red";
    }

    // ðŸ’° Deposit covering payout
    else if (credit > 0 && pendingPayout > 0) {
      if (credit < pendingPayout) {
        pendingPayout -= credit;
        rowClass = "red";
      }
      else if (credit === pendingPayout) {
        pendingPayout = 0;
        rowClass = "green";
      }
      else {
        surplus = (credit - pendingPayout).toFixed(2);
        pendingPayout = 0;
        rowClass = "yellow";
      }
    }

    processed.push({
      doc,
      date,
      tranType,
      description,
      enteredBy,
      credit,
      debit,
      total,
      surplus,
      rowClass
    });
  }

  // Back to newest â†’ oldest for display
  processed.reverse();

  document.getElementById("status").innerHTML =
    pendingPayout === 0
      ? `<span style="color:green">GOOD TO GO â€“ All payouts covered</span>`
      : `<span style="color:red">UNCOVERED PAYOUTS â€“ Missing $${pendingPayout.toFixed(2)}</span>`;

  renderTable(processed);
}

function renderTable(rows) {
  let html = `
  <table>
    <tr>
      <th>Document Number</th>
      <th>TranDateTime</th>
      <th>TranType</th>
      <th>Description</th>
      <th>EnteredBy</th>
      <th>CreditedAmount</th>
      <th>DebitAmount</th>
      <th>TotalAmount</th>
      <th>Surplus After Cover</th>
    </tr>`;

  for (let r of rows) {
    html += `
    <tr class="${r.rowClass}">
      <td>${r.doc}</td>
      <td>${r.date}</td>
      <td>${r.tranType}</td>
      <td>${r.description}</td>
      <td>${r.enteredBy}</td>
      <td>${r.credit.toFixed(2)}</td>
      <td>${r.debit.toFixed(2)}</td>
      <td>${r.total.toFixed(2)}</td>
      <td>${r.surplus}</td>
    </tr>`;
  }

  html += "</table>";
  document.getElementById("output").innerHTML = html;
}

function clearAll() {
  document.getElementById("input").value = "";
  document.getElementById("output").innerHTML = "";
  document.getElementById("status").innerHTML = "";
}
</script>

</body>
</html>
